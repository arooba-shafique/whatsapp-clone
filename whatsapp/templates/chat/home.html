{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>

    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
        font-family: sans-serif;
    }

    .chat-home-container {
        display: flex;
        height: 100vh;
        width: 100vw;
        background-color: #e5ddd5;
        overflow: hidden;
    }

    .icon-bar {
        width: 70px;
        background-color: #f0f2f5;
        border-right: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
    }

    .icon-bar .top-icons,
    .icon-bar .bottom-icons {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .icon-bar .top-icons {
        margin-bottom: 10px;
        transform: translateY(-20px);
    }

    .icon-bar .bottom-icons {
        margin-bottom: 40px;
        transform: translateY(-50px);
    }

    .icon-bar .top-icons i,
    .icon-bar .bottom-icons i {
        font-size: 18px;
        color: #555;
        margin: 20px 0;
        cursor: pointer;
    }

    .icon-bar .bottom-icons a img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-bottom: 10px;
        cursor: pointer;
        object-fit: cover;
    }

    .settings-dropdown {
        position: absolute;
        bottom: 80px;
        left: 80px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 999;
        width: 200px;
        padding: 10px;
        display: none;
    }

    .settings-dropdown a {
        display: block;
        padding: 8px 10px;
        text-decoration: none;
        color: #333;
        border-radius: 4px;
    }

    .settings-dropdown a:hover {
        background-color: #f1f1f1;
    }

    .chat-home-sidebar { 
        width: 25%;
        background-color: #fff;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
    }

    .sidebar {
        width: 25%; 
        max-width: 400px; 
        min-width: 300px;
        background-color: #fff;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 10px 15px;
        background-color: #f0f0f0;
        border-bottom: 1px solid #ddd;
        display: flex; 
        align-items: center;
    }

    .sidebar-header input {
        width: 100%;
        border: none;
        border-radius: 20px;
        padding: 8px 15px;
        background-color: #ececec;
        font-size: 14px;
        flex-grow: 1; 
    }

    .user-list {
        flex: 1;
        overflow-y: auto;
    }

    .chat-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f1f1f1;
        transition: background-color 0.2s;
        text-decoration: none;
        color: inherit;
    }

    .chat-item:hover {
        background-color: #f5f5f5;
    }

    .profile-pic { 
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #ccc;
        margin-right: 12px;
        object-fit: cover;
    }

    .chat-home-main {
        flex: 1;
        background-image: url("{% static 'whatsapp-bg.png' %}");
        background-size: cover;
        background-position: center;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        color: #888;
    }

    .status-dropdown {
        position: absolute;
        top: 40px;
        left: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        width: 180px;
        padding: 10px;
    }

    .status-dropdown a {
        display: block;
        padding: 8px 10px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
        border-radius: 4px;
    }

    .status-dropdown a:hover {
        background-color: #f1f1f1;
    }
    .menu-dropdown { 
        position: absolute;
        top: 25px;
        right: 0px; 
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        width: 150px;
        padding: 10px;
        display: none;
    }

    .menu-dropdown a {
        display: block;
        padding: 8px 10px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
        border-radius: 4px;
    }

    .menu-dropdown a:hover {
        background-color: #f1f1f1;
    }


    .chat-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .name-time {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 2px; 
    }

    .chat-name {
        font-weight: bold;
        font-size: 16px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-grow: 1; 
    }

    .chat-time {
        font-size: 12px;
        color: #999;
        margin-left: 10px; 
        white-space: nowrap;
    }

    .last-message-preview {
        font-size: 14px;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: flex; 
        align-items: center;
    }

    .sender-prefix {
        color: #333; 
        margin-right: 4px;
    }

    .tick-icon {
        margin-right: 4px; 
        font-size: 12px; 
    }
    .tick-icon .fa-check { color: #888; } 
    .tick-icon .fa-check-double { color: #888; }
    .tick-icon .fa-check-double.text-blue-500 { color: #34b7f1; }

    .unread-badge {
        background-color: #25d366;
        color: white;
        padding: 2px 7px;
        border-radius: 10px;
        font-size: 11px;
        min-width: 18px; 
        text-align: center;
        margin-left: auto; 
        line-height: 1; 
    }
    .no-messages-found {
        padding: 20px;
        text-align: center;
        color: #888;
        font-size: 14px;
    }
    .select-chat-placeholder {
        text-align: center;
        color: #888;
    }
    .select-chat-placeholder i {
        margin-bottom: 10px;
    }

</style>

<div class="chat-home-container">
    <div class="icon-bar">
        <div class="top-icons">
            <i class="fas fa-comment-dots" title="Chats"></i>
            <div class="dropdown" style="position: relative;">
                <div class="relative" style="position: relative;">
                    <i class="fas fa-circle-notch" title="Status" id="statusIcon" style="cursor: pointer;"></i>
                    {% if has_unseen_status %}
                        <span style="
                            position: absolute;
                            top: 0;
                            right: 0;
                            width: 8px;
                            height: 8px;
                            background-color: green;
                            border-radius: 50%;
                            border: 1px solid white;
                        "></span>
                    {% endif %}
                </div>
                <div id="statusMenu" class="status-dropdown" style="display: none;">
                    <a href="{% url 'status_view' %}">ðŸ‘€ View Status</a>
                    <a href="{% url 'status_upload' %}">âž• Add Status</a>
                </div>
            </div>
            <a href="{% url 'create_group' %}" title="Create Group">
                <i class="fas fa-users" style="cursor: pointer;"></i>
            </a>
        </div>

        <div class="bottom-icons">
            <div class="dropdown" style="position: relative;">
                <i class="fas fa-cog" title="Settings" id="settingsIcon" style="cursor: pointer;"></i>
                <div id="settingsMenu" class="settings-dropdown">
                    <a href="{% url 'profile_sidebar' %}">Profile</a>
                    <a href="{% url 'help_center' %}">Help</a>
                    <a href="{% url 'logout' %}">Logout</a>
                </div>
            </div>
            <a href="{% url 'profile_sidebar' %}" title="My Profile">
                {% if request.user.profile_picture %}
                    <img src="{{ request.user.profile_picture.url }}" alt="Me">
                {% else %}
                    <img src="{% static 'default-profile.png' %}" alt="Me">
                {% endif %}
            </a>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <input type="text" id="chatSearch" placeholder="Search or start new chat" class="form-control mb-2">

           <a href="{% url 'add_contact' %}" class="btn btn-success btn-sm rounded-pill px-3 py-1 border-0">
    Add Contact
</a>


            <div class="dropdown" style="position: relative; margin-left: 10px;">
                <i class="fas fa-ellipsis-v menu-icon" id="menuIcon" title="Menu" style="cursor: pointer;"></i>
                <div id="menuDropdown" class="menu-dropdown"> 
                    <a href="{% url 'profile_sidebar' %}">Profile</a>
                    <a href="{% url 'starred_messages' %}">Starred Messages</a>
                    <a href="{% url 'create_group' %}">Create Group</a>
                    <a href="{% url 'add_contact' %}">Add Contact</a>


                    <a href="{% url 'logout' %}">Log out</a>
                </div>
            </div>
        </div>

        <div class="user-list">
            {% for chat_item in combined_chats_data %}
                {% if chat_item.user_obj %} 
                    {% with user=chat_item.user_obj last_message=chat_item.last_message unread_count=chat_item.unread_count %}
                        <a href="{% url 'chat_detail' user.id %}" class="chat-item">
{% if user.profile_picture %}
    <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" class="profile-pic">
{% else %}
    <img src="{% static 'default-profile.png' %}" alt="{{ user.username }}" class="profile-pic">
{% endif %}
                            <div class="chat-info">
                                <div class="name-time">
                                    <span class="chat-name">{{ user.username }}</span>
                                    {% if last_message %}<span class="chat-time">{{ last_message.timestamp|date:"H:i" }}</span>{% endif %}
                                </div>
                                <div class="last-message-preview">
                                    {% if last_message %}
                                        {% if last_message.sender == request.user %}
                                            <span class="tick-icon">
                                                {% if last_message.status == 'seen' %}
                                                    <i class="fas fa-check-double text-blue-500"></i>
                                                {% elif last_message.status == 'delivered' %}
                                                    <i class="fas fa-check-double"></i>
                                                {% else %}
                                                    <i class="fas fa-check"></i>
                                                {% endif %}
                                            </span>
                                            <span class="sender-prefix">You: </span>
                                        {% endif %}

                                        {% if last_message.is_deleted %}
                                            <span class="deleted-message">This message was deleted</span>
                                        {% elif last_message.message_type == 'text' %}
                                            <span>{{ last_message.message|truncatechars:30 }}</span>
                                        {% elif last_message.message_type == 'image' %}
                                            <i class="fas fa-image"></i> Image
                                        {% elif last_message.message_type == 'video' %}
                                            <i class="fas fa-video"></i> Video
                                        {% elif last_message.message_type == 'audio' %}
                                            <i class="fas fa-music"></i> Audio
                                        {% elif last_message.file %} 
                                            <i class="fas fa-file"></i> File
                                        {% endif %}
                                    {% else %}
                                        <span class="no-message">No messages yet.</span>
                                    {% endif %}
                                </div>
                                {% if unread_count > 0 %}
                                    <span class="unread-badge">{{ unread_count }}</span>
                                {% endif %}
                            </div>
                        </a>
                    {% endwith %}

                {% elif chat_item.group_obj %} }
                    {% with group=chat_item.group_obj last_message=chat_item.last_message unread_count=chat_item.unread_count %}
                        <a href="{% url 'group_chat_detail' group.id %}" class="chat-item">
                            <img src="{{ group.icon.url|default:'/static/default-group.png' }}" alt="{{ group.name }}" class="profile-pic">
                            <div class="chat-info">
                                <div class="name-time">
                                    <span class="chat-name">{{ group.name }}</span>
                                    {% if last_message %}<span class="chat-time">{{ last_message.timestamp|date:"H:i" }}</span>{% endif %}
                                </div>
                                <div class="last-message-preview">
                                    {% if last_message %}
                                        {% if last_message.sender == request.user %}
                                            <span class="sender-prefix">You: </span>
                                        {% else %}
                                            <span class="sender-prefix">{{ last_message.sender.username }}: </span>
                                        {% endif %}

                                        {% if last_message.is_deleted %}
                                            <span class="deleted-message">This message was deleted</span>
                                        {% elif last_message.message_type == 'text' %}
                                            <span>{{ last_message.message|truncatechars:30 }}</span>
                                        {% elif last_message.message_type == 'image' %}
                                            <i class="fas fa-image"></i> Image
                                        {% elif last_message.message_type == 'video' %}
                                            <i class="fas fa-video"></i> Video
                                        {% elif last_message.message_type == 'audio' %}
                                            <i class="fas fa-music"></i> Audio
                                        {% elif last_message.file %} 
                                            <i class="fas fa-file"></i> File
                                        {% endif %}
                                    {% else %}
                                        <span class="no-message">No messages yet.</span>
                                    {% endif %}
                                </div>
                                {% if unread_count > 0 %}
                                    <span class="unread-badge">{{ unread_count }}</span>
                                {% endif %}
                            </div>
                        </a>
                    {% endwith %}
                {% endif %}
            {% empty %}
                <p class="no-chats-found">No chats found. Start a new conversation!</p>
            {% endfor %}
        </div>
    </div>

    <div class="chat-home-main">
        <div class="select-chat-placeholder">
            <i class="fas fa-comments" style="font-size: 48px;"></i><br>
            Select a chat to start messaging
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>

<script type="module" src="{% static 'js/utils.js' %}"></script>
<script type="module" src="{% static 'js/modals.js' %}"></script>
<script type="module" src="{% static 'js/forward.js' %}"></script>
<script type="module" src="{% static 'js/dropdowns.js' %}"></script>
<script type="module" src="{% static 'js/star_toggle.js' %}"></script>
<script type="module" src="{% static 'js/reactions.js' %}"></script>
<script type="module" src="{% static 'js/emoji_picker.js' %}"></script>
<script type="module" src="{% static 'js/emoji_reactions.js' %}"></script>
<script type="module" src="{% static 'js/messages.js' %}"></script>
<script type="module" src="{% static 'js/star_toggle.js' %}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const settingsIcon = document.getElementById("settingsIcon");
        const settingsMenu = document.getElementById("settingsMenu");
        const statusIcon = document.getElementById("statusIcon");
        const statusMenu = document.getElementById("statusMenu");
        const menuIcon = document.getElementById("menuIcon");
        const menuDropdown = document.getElementById("menuDropdown"); 

        if (settingsIcon && settingsMenu) {
            settingsIcon.addEventListener("click", function (e) {
                e.stopPropagation();
                settingsMenu.style.display = settingsMenu.style.display === "none" ? "block" : "none";
            });

            document.addEventListener("click", function (e) {
                if (!settingsMenu.contains(e.target) && e.target !== settingsIcon) {
                    settingsMenu.style.display = "none";
                }
            });
        }

        if (statusIcon && statusMenu) {
            statusIcon.addEventListener("click", function (e) {
                e.stopPropagation();
                statusMenu.style.display = statusMenu.style.display === "none" ? "block" : "none";
            });

            document.addEventListener("click", function (e) {
                if (!statusMenu.contains(e.target) && e.target !== statusIcon) {
                    statusMenu.style.display = "none";
                }
            });
        }

        if (menuIcon && menuDropdown) {
            menuIcon.addEventListener("click", function (e) {
                e.stopPropagation();
                menuDropdown.style.display = menuDropdown.style.display === "none" ? "block" : "none";
            });

            document.addEventListener("click", function (e) {
                if (!menuDropdown.contains(e.target) && e.target !== menuIcon) {
                    menuDropdown.style.display = "none";
                }
            });
        }
    });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("chatSearch");
    searchInput.addEventListener("keyup", function () {
        const filter = searchInput.value.toLowerCase();
        const chatEntries = document.querySelectorAll(".chat-item");

        chatEntries.forEach(entry => {
            const chatNameElement = entry.querySelector(".chat-name");
            const name = chatNameElement ? chatNameElement.textContent.toLowerCase() : ''; 

            if (name.includes(filter)) {
                entry.style.display = ""; 
            } else {
                entry.style.display = "none"; 
            }
        });
    });
});
</script>


{% endblock %}